<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redirecci√≥n WhatsApp</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    }
    .loading {
      text-align: center;
      font-size: 14px;
      color: #aaa;
    }
  </style>
</head>
<body>

  <p class="loading">Redirigiendo a un canal activo de WhatsApp...</p>

  <script>
  /********************************************
   * CONFIGURACI√ìN
   ********************************************/
  const USE_API = true;   // true = n√∫meros desde API  |  false = n√∫meros desde phones.json

  const API_URL      = "/api/get-random-phone";
  const JSON_FILE    = "./phones.json";
  const FALLBACK     = [{ phone: "5491169789243", weight: 1 }];
  const TTL_MS       = 5 * 60 * 1000;
  const LS_KEY       = "active_whatsapp_numbers";
  const WA_MESSAGE   = "¬°Hola! Me pas√°s mi usuario üöÄ";

  /********************************************
   * Helpers
   ********************************************/
  function fetchWithTimeout(url, opts = {}, ms = 2500) {
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), ms);
    return fetch(url, { ...opts, signal: ctrl.signal }).finally(() => clearTimeout(id));
  }

  function getCache() {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); }
    catch { return null; }
  }

  function setCache(numbers) {
    localStorage.setItem(LS_KEY, JSON.stringify({ ts: Date.now(), numbers }));
  }

  function normalize(list) {
    return (Array.isArray(list) ? list : [])
      .map(n => ({
        phone: String(n.phone || n.phone_number || "").replace(/\D+/g, "").trim(),
        weight: Number(n.weight || 1)
      }))
      .filter(n => /^\d{8,17}$/.test(n.phone) && n.weight > 0);
  }

  function parseApiPayload(data) {
    if (data && typeof data === "object" && (typeof data.phone_number === "string" || typeof data.phone_number === "number")) {
      return [{ phone: String(data.phone_number), weight: 1 }];
    }
    if (typeof data === "string") return [{ phone: data, weight: 1 }];
    const arr =
      (Array.isArray(data?.numbers) && data.numbers) ||
      (Array.isArray(data?.phone_numbers) && data.phone_numbers) ||
      (Array.isArray(data?.whatsapp) && data.whatsapp) ||
      (Array.isArray(data) && data) || [];
    return arr.map(item => {
      if (typeof item === "string") return { phone: item, weight: 1 };
      const phone = String(item?.phone ?? item?.phone_number ?? "").trim();
      const w = Number(item?.weight ?? 1);
      return { phone, weight: isFinite(w) && w > 0 ? w : 1 };
    });
  }

  function pickWeightedRandom(list) {
    const total = list.reduce((s, it) => s + it.weight, 0);
    let r = Math.random() * total;
    for (const it of list) { r -= it.weight; if (r <= 0) return it; }
    return list[list.length - 1];
  }

  function buildWaUrl(phone, text) {
    const clean = phone.replace(/\D/g, "");
    const encoded = text ? encodeURIComponent(text) : "";
    return `https://api.whatsapp.com/send?phone=${clean}${encoded ? `&text=${encoded}` : ""}`;
  }

  /********************************************
   * Obtener n√∫meros seg√∫n USE_API
   ********************************************/
  async function fetchFromApi() {
    const res = await fetchWithTimeout(API_URL, { headers: { "Cache-Control": "no-store" } }, 2500);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    return normalize(parseApiPayload(data));
  }

  async function fetchFromJson() {
    const res = await fetch(JSON_FILE);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    return normalize(Array.isArray(data) ? data.map(item => {
      if (typeof item === "string") return { phone: item, weight: 1 };
      return item;
    }) : []);
  }

  async function loadNumbers() {
    const cached = getCache();
    try {
      const numbers = USE_API ? await fetchFromApi() : await fetchFromJson();
      if (numbers.length) { setCache(numbers); return numbers; }
      throw new Error("Empty list");
    } catch (e) {
      if (cached?.numbers?.length && Date.now() - (cached.ts || 0) < TTL_MS) return cached.numbers;
      return normalize(FALLBACK);
    }
  }

  /********************************************
   * Redirecci√≥n
   ********************************************/
  async function redirect() {
    const list = await loadNumbers();
    if (!list.length) {
      document.querySelector(".loading").textContent = "Error: no hay n√∫meros activos.";
      return;
    }
    const chosen = pickWeightedRandom(list);
    window.location.replace(buildWaUrl(chosen.phone, WA_MESSAGE));
  }

  redirect();
  </script>
</body>
</html>
